generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/africanmarket/app/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  VENDOR
  DRIVER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum RideStatus {
  PENDING
  ACCEPTED
  DRIVER_ARRIVING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  password      String?
  phone         String?
  role          UserRole @default(CUSTOMER)
  avatar        String?
  isVerified    Boolean  @default(false)
  isActive      Boolean  @default(true)
  
  // Enhanced authentication fields
  emailVerified         Boolean   @default(false)
  emailVerifiedAt       DateTime?
  phoneVerified         Boolean   @default(false)
  phoneVerifiedAt       DateTime?
  kycVerified           Boolean   @default(false)
  kycVerifiedAt         DateTime?
  profileCompleted      Boolean   @default(false)
  profileCompletedAt    DateTime?
  
  // Security fields
  failedLoginAttempts   Int       @default(0)
  lockedUntil           DateTime?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  
  // Two-factor authentication
  twoFactorEnabled      Boolean   @default(false)
  twoFactorSecret       String?
  twoFactorBackupCodes  String[]
  
  // Social login fields
  socialProviders       String[]
  
  // Additional profile fields
  firstName             String?
  lastName              String?
  dateOfBirth           DateTime?
  gender                String?
  address               String?
  city                  String?
  province              String?
  postalCode            String?
  country               String?   @default("Canada")
  timezone              String?   @default("America/St_Johns")
  language              String?   @default("en")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  accounts           Account[]
  sessions           Session[]
  customerOrders     Order[]              @relation("CustomerOrders")
  vendorProfile      Vendor?
  driverProfile      Driver?
  customerRides      Ride[]               @relation("CustomerRides")
  reviews            Review[]
  payments           Payment[]
  notifications      Notification[]
  chatMessages       ChatMessage[]
  addresses          Address[]
  verificationTokens VerificationToken[]
  documents          Document[]
  kycApplications    KYCApplication[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Vendor {
  id                    String             @id @default(cuid())
  userId                String             @unique
  businessName          String
  businessType          String
  description           String?
  logo                  String?
  coverImage            String?
  address               String
  city                  String
  province              String             @default("Newfoundland and Labrador")
  postalCode            String
  latitude              Float?
  longitude             Float?
  phone                 String
  businessHours         Json?
  verificationStatus    VerificationStatus @default(PENDING)
  verificationDocuments Json?
  foodSafetyCertificate String?
  businessLicense       String?
  isActive              Boolean            @default(true)
  commissionRate        Float              @default(0.20)
  rating                Float              @default(0)
  totalReviews          Int                @default(0)
  
  // Enhanced business information
  businessEmail         String?
  businessWebsite       String?
  businessRegistrationNumber String?
  taxNumber             String?
  businessCategory      String?
  businessSubcategory   String?
  cuisineTypes          String[]           // For food vendors
  servingRadius         Float?             // in kilometers
  minimumOrderAmount    Float?
  deliveryFee           Float?
  deliveryTime          String?            // e.g., "30-45 minutes"
  
  // Social media
  facebookUrl           String?
  instagramUrl          String?
  twitterUrl            String?
  
  // Business verification
  businessVerified      Boolean            @default(false)
  businessVerifiedAt    DateTime?
  foodSafetyVerified    Boolean            @default(false)
  foodSafetyVerifiedAt  DateTime?
  taxVerified           Boolean            @default(false)
  taxVerifiedAt         DateTime?
  
  // Operational settings
  acceptsPreorders      Boolean            @default(false)
  acceptsCashOnDelivery Boolean            @default(true)
  acceptsCardPayment    Boolean            @default(true)
  acceptsDigitalPayment Boolean            @default(true)
  
  // Profile completion
  profileCompletionScore Int               @default(0) // 0-100
  onboardingCompleted   Boolean            @default(false)
  onboardingCompletedAt DateTime?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  products     Product[]
  orders       Order[]
  reviews      Review[]
  earnings     Earning[]
}

model Product {
  id          String   @id @default(cuid())
  vendorId    String
  name        String
  description String?
  price       Float
  category    String
  image       String?
  images      String[]
  isAvailable Boolean  @default(true)
  ingredients String?
  allergens   String?
  isSpicy     Boolean  @default(false)
  prepTime    Int?     // in minutes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vendor     Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  reviews    Review[]
}

model Driver {
  id                    String             @id @default(cuid())
  userId                String             @unique
  licenseNumber         String
  vehicleType           String
  vehicleMake           String
  vehicleModel          String
  vehicleYear           Int
  vehicleColor          String
  vehiclePlate          String
  vehicleImage          String?
  licenseImage          String?
  insuranceImage        String?
  verificationStatus    VerificationStatus @default(PENDING)
  isAvailable           Boolean            @default(false)
  currentLatitude       Float?
  currentLongitude      Float?
  commissionRate        Float              @default(0.25)
  rating                Float              @default(0)
  totalReviews          Int                @default(0)
  totalDeliveries       Int                @default(0)
  totalRides            Int                @default(0)
  
  // Enhanced driver information
  licenseExpiry         DateTime?
  licenseClass          String?            // Class of license
  licenseIssuedBy       String?            // Province/Authority
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?
  
  // Vehicle details
  vehicleVin            String?
  vehicleRegistrationExpiry DateTime?
  vehicleInspectionExpiry DateTime?
  vehicleInsuranceExpiry DateTime?
  vehicleInsuranceProvider String?
  vehicleInsurancePolicyNumber String?
  
  // Service preferences
  serviceTypes          String[]           // DELIVERY, RIDESHARE, BOTH
  serviceRadius         Float?             // in kilometers
  workingHours          Json?              // Similar to business hours
  preferredAreas        String[]           // Preferred service areas
  
  // Background check
  backgroundCheckStatus VerificationStatus @default(PENDING)
  backgroundCheckDate   DateTime?
  criminalRecordCheck   Boolean            @default(false)
  drivingRecordCheck    Boolean            @default(false)
  
  // Driver verification
  licenseVerified       Boolean            @default(false)
  licenseVerifiedAt     DateTime?
  vehicleVerified       Boolean            @default(false)
  vehicleVerifiedAt     DateTime?
  insuranceVerified     Boolean            @default(false)
  insuranceVerifiedAt   DateTime?
  backgroundVerified    Boolean            @default(false)
  backgroundVerifiedAt  DateTime?
  
  // Operational settings
  acceptsCashPayment    Boolean            @default(true)
  acceptsCardPayment    Boolean            @default(true)
  acceptsDigitalPayment Boolean            @default(true)
  canDeliverFood        Boolean            @default(true)
  canTransportPassengers Boolean           @default(true)
  hasInsulatedBag       Boolean            @default(false)
  hasGpsDevice          Boolean            @default(false)
  
  // Profile completion
  profileCompletionScore Int               @default(0) // 0-100
  onboardingCompleted   Boolean            @default(false)
  onboardingCompletedAt DateTime?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveryOrders    Order[]
  rides             Ride[]
  reviews           Review[]
  earnings          Earning[]
}

model Order {
  id                String      @id @default(cuid())
  customerId        String
  vendorId          String
  driverId          String?
  orderNumber       String      @unique
  status            OrderStatus @default(PENDING)
  items             OrderItem[]
  subtotal          Float
  deliveryFee       Float
  tax               Float
  totalAmount       Float
  paymentStatus     PaymentStatus @default(PENDING)
  paymentMethod     String?
  specialInstructions String?
  isDelivery        Boolean     @default(true)
  deliveryAddress   String?
  deliveryLatitude  Float?
  deliveryLongitude Float?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  customer      User        @relation("CustomerOrders", fields: [customerId], references: [id])
  vendor        Vendor      @relation(fields: [vendorId], references: [id])
  driver        Driver?     @relation(fields: [driverId], references: [id])
  payment       Payment?
  review        Review?
  tracking      OrderTracking[]
  notifications Notification[]
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  subtotal  Float
  notes     String?

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model Ride {
  id                  String     @id @default(cuid())
  customerId          String
  driverId            String?
  rideNumber          String     @unique
  status              RideStatus @default(PENDING)
  pickupAddress       String
  pickupLatitude      Float
  pickupLongitude     Float
  destinationAddress  String
  destinationLatitude Float
  destinationLongitude Float
  distance            Float?     // in km
  estimatedDuration   Int?       // in minutes
  estimatedFare       Float?
  actualFare          Float?
  paymentStatus       PaymentStatus @default(PENDING)
  paymentMethod       String?
  notes               String?
  requestedAt         DateTime   @default(now())
  acceptedAt          DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  customer      User         @relation("CustomerRides", fields: [customerId], references: [id])
  driver        Driver?      @relation(fields: [driverId], references: [id])
  payment       Payment?
  review        Review?
  tracking      RideTracking[]
  notifications Notification[]
}

model Payment {
  id                String        @id @default(cuid())
  userId            String
  orderId           String?       @unique
  rideId            String?       @unique
  amount            Float
  currency          String        @default("CAD")
  status            PaymentStatus @default(PENDING)
  paymentMethod     String
  stripePaymentId   String?
  paypalPaymentId   String?
  platformFee       Float
  vendorAmount      Float?
  driverAmount      Float?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])
  ride  Ride?  @relation(fields: [rideId], references: [id])
}

model Review {
  id         String   @id @default(cuid())
  userId     String
  vendorId   String?
  productId  String?
  driverId   String?
  orderId    String?  @unique
  rideId     String?  @unique
  rating     Int      // 1-5
  comment    String?
  images     String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id])
  vendor   Vendor?  @relation(fields: [vendorId], references: [id])
  product  Product? @relation(fields: [productId], references: [id])
  driver   Driver?  @relation(fields: [driverId], references: [id])
  order    Order?   @relation(fields: [orderId], references: [id])
  ride     Ride?    @relation(fields: [rideId], references: [id])
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  type        String   // home, work, other
  address     String
  city        String
  province    String
  postalCode  String
  latitude    Float?
  longitude   Float?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OrderTracking {
  id        String   @id @default(cuid())
  orderId   String
  status    OrderStatus
  message   String?
  latitude  Float?
  longitude Float?
  timestamp DateTime @default(now())

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model RideTracking {
  id        String   @id @default(cuid())
  rideId    String
  status    RideStatus
  message   String?
  latitude  Float?
  longitude Float?
  timestamp DateTime @default(now())

  // Relations
  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  orderId   String?
  rideId    String?
  type      String   // order_update, ride_update, payment, promotion
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id])
  ride  Ride?  @relation(fields: [rideId], references: [id])
}

model ChatMessage {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  orderId    String?
  rideId     String?
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  sender User @relation(fields: [senderId], references: [id])
}

model Earning {
  id          String   @id @default(cuid())
  vendorId    String?
  driverId    String?
  orderId     String?
  rideId      String?
  amount      Float
  commission  Float
  netAmount   Float
  type        String   // delivery, ride, bonus
  description String?
  createdAt   DateTime @default(now())

  // Relations
  vendor Vendor? @relation(fields: [vendorId], references: [id])
  driver Driver? @relation(fields: [driverId], references: [id])
}

model SystemConfig {
  id                  String   @id @default(cuid())
  key                 String   @unique
  value               String
  description         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// New models for enhanced authentication

enum TokenType {
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR_SETUP
  ACCOUNT_ACTIVATION
}

enum DocumentType {
  PROFILE_PHOTO
  GOVERNMENT_ID
  DRIVERS_LICENSE
  VEHICLE_REGISTRATION
  VEHICLE_INSURANCE
  BUSINESS_LICENSE
  FOOD_SAFETY_CERTIFICATE
  BUSINESS_REGISTRATION
  TAX_CERTIFICATE
  BANK_STATEMENT
  PROOF_OF_ADDRESS
  OTHER
}

enum DocumentStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum KYCStatus {
  NOT_STARTED
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  REJECTED
  EXPIRED
  RESUBMISSION_REQUIRED
}

model VerificationToken {
  id        String    @id @default(cuid())
  userId    String
  type      TokenType
  token     String    @unique
  code      String?   // For SMS/Email verification codes
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  attempts  Int       @default(0)
  maxAttempts Int     @default(3)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, type])
}

model Document {
  id           String         @id @default(cuid())
  userId       String
  type         DocumentType
  title        String
  description  String?
  fileName     String
  filePath     String
  fileSize     Int
  mimeType     String
  cloudinaryId String?
  status       DocumentStatus @default(PENDING)
  uploadedAt   DateTime       @default(now())
  reviewedAt   DateTime?
  reviewedBy   String?
  rejectionReason String?
  expiresAt    DateTime?
  metadata     Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  kycApplications KYCApplication[] @relation("KYCDocuments")

  @@index([userId, type])
  @@index([status])
}

model KYCApplication {
  id                String        @id @default(cuid())
  userId            String
  status            KYCStatus     @default(NOT_STARTED)
  applicationLevel  String        @default("BASIC") // BASIC, STANDARD, PREMIUM
  submittedAt       DateTime?
  reviewedAt        DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  expiresAt         DateTime?
  reviewedBy        String?
  rejectionReason   String?
  notes             String?
  completionScore   Int           @default(0) // 0-100
  
  // Required documents checklist
  profilePhotoRequired      Boolean @default(true)
  governmentIdRequired      Boolean @default(true)
  proofOfAddressRequired    Boolean @default(true)
  businessLicenseRequired   Boolean @default(false)
  foodSafetyRequired        Boolean @default(false)
  driversLicenseRequired    Boolean @default(false)
  vehicleRegistrationRequired Boolean @default(false)
  vehicleInsuranceRequired  Boolean @default(false)
  
  // Document verification status
  profilePhotoVerified      Boolean @default(false)
  governmentIdVerified      Boolean @default(false)
  proofOfAddressVerified    Boolean @default(false)
  businessLicenseVerified   Boolean @default(false)
  foodSafetyVerified        Boolean @default(false)
  driversLicenseVerified    Boolean @default(false)
  vehicleRegistrationVerified Boolean @default(false)
  vehicleInsuranceVerified  Boolean @default(false)
  
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[] @relation("KYCDocuments")

  @@index([userId])
  @@index([status])
}

model LoginAttempt {
  id          String   @id @default(cuid())
  email       String
  ipAddress   String
  userAgent   String?
  successful  Boolean
  failureReason String?
  timestamp   DateTime @default(now())
  country     String?
  city        String?
  device      String?
  
  @@index([email])
  @@index([ipAddress])
  @@index([timestamp])
}

model PasswordResetLog {
  id          String   @id @default(cuid())
  userId      String
  email       String
  ipAddress   String
  userAgent   String?
  tokenUsed   String
  successful  Boolean
  timestamp   DateTime @default(now())
  
  @@index([userId])
  @@index([email])
  @@index([timestamp])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // LOGIN, LOGOUT, PROFILE_UPDATE, DOCUMENT_UPLOAD, etc.
  resource    String?  // The resource being acted upon
  resourceId  String?  // ID of the resource
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}
